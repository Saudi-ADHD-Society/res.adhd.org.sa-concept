---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumb from '../../../components/Breadcrumb.jsx';
import { getCollection } from 'astro:content';
import { t } from '../../../utils/i18n';

const basePath = import.meta.env.BASE_URL;
const locale = 'en';

const site = import.meta.env.SITE || 'https://saudi-adhd-society.github.io';

export async function getStaticPaths() {
  const papers = await getCollection('papers');
  return papers
    .filter(paper => !paper.data.visibility?.hidden)
    .map((paper) => ({
      params: { slug: paper.data.slug },
      props: { paper },
    }));
}

const { paper } = Astro.props;
const paperData = paper.data;

// Build meta description from abstract (truncate to ~160 chars)
const metaDescription = paperData.abstract 
  ? paperData.abstract.slice(0, 157) + (paperData.abstract.length > 157 ? '...' : '')
  : `Research paper: ${paperData.title}`;

// Build canonical URL
const canonicalUrl = `${site}${basePath}${locale}/library/${paperData.slug}/`;

// Format authors
const formatAuthors = (authors) => {
  if (!authors || authors.length === 0) return '';
  return authors.map(a => `${a.given} ${a.family}`).join(', ');
};

// Format journal citation
const formatJournalCitation = () => {
  const parts = [];
  if (paperData.journal?.name || paperData.journal?.abbreviation) {
    parts.push(paperData.journal.name || paperData.journal.abbreviation);
  }
  if (paperData.publication?.year) {
    parts.push(`(${paperData.publication.year})`);
  }
  if (paperData.journal?.volume) {
    parts.push(`Vol. ${paperData.journal.volume}`);
  }
  if (paperData.journal?.issue) {
    parts.push(`Issue ${paperData.journal.issue}`);
  }
  if (paperData.journal?.pages?.start) {
    const pageStr = paperData.journal.pages.end 
      ? `${paperData.journal.pages.start}-${paperData.journal.pages.end}`
      : paperData.journal.pages.start;
    parts.push(`pp. ${pageStr}`);
  }
  return parts.join(' ');
};
---

<BaseLayout title={`${paperData.title} - Research Library`} description={metaDescription} locale={locale}>
  <main class="max-w-4xl mx-auto px-4 md:px-8 py-10 min-h-[60vh]">
    <Breadcrumb client:load basePath={basePath} locale={locale} />
    
    <article class="space-y-6">
      <!-- Title -->
      <header>
        <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-4">{paperData.title}</h1>
      </header>

      <!-- Authors -->
      {paperData.authors && paperData.authors.length > 0 && (
        <div>
          <h2 class="text-sm font-semibold text-slate-700 mb-2">Authors</h2>
          <p class="text-slate-800">{formatAuthors(paperData.authors)}</p>
        </div>
      )}

      <!-- Journal & Publication Info -->
      {(paperData.journal || paperData.publication) && (
        <div>
          <h2 class="text-sm font-semibold text-slate-700 mb-2">Publication</h2>
          <div class="text-slate-800 space-y-1">
            {formatJournalCitation() && <p>{formatJournalCitation()}</p>}
            {paperData.journal?.issn && (
              <p class="text-sm text-slate-600">ISSN: {paperData.journal.issn}</p>
            )}
                {paperData.publication?.publishedDate && (
              <p class="text-sm text-slate-600">
                Published: {new Date(paperData.publication.publishedDate).toLocaleDateString(locale === 'ar' ? 'ar-SA' : 'en-US', {
                  year: 'numeric', 
                  month: 'long', 
                  day: 'numeric' 
                })}
              </p>
            )}
          </div>
        </div>
      )}

      <!-- Language -->
      {paperData.language && (
        <div>
          <h2 class="text-sm font-semibold text-slate-700 mb-2">Language</h2>
          <p class="text-slate-800">{paperData.language}</p>
        </div>
      )}

      <!-- DOI -->
      {paperData.doi && (
        <div>
          <h2 class="text-sm font-semibold text-slate-700 mb-2">DOI</h2>
          <a
            href={`https://doi.org/${paperData.doi}`}
            target="_blank"
            rel="noreferrer"
            class="text-emerald-700 hover:text-emerald-800 font-medium break-all"
          >
            {paperData.doi}
          </a>
        </div>
      )}

      <!-- Abstract -->
      {paperData.abstract && (
        <div>
          <h2 class="text-sm font-semibold text-slate-700 mb-2">Abstract</h2>
          <p class="text-slate-800 leading-relaxed whitespace-pre-wrap">{paperData.abstract}</p>
        </div>
      )}

      <!-- Keywords -->
      {paperData.keywords && paperData.keywords.length > 0 && (
        <div>
          <h2 class="text-sm font-semibold text-slate-700 mb-2">Keywords</h2>
          <div class="flex flex-wrap gap-2">
            {paperData.keywords.map(keyword => (
              <span class="px-3 py-1 bg-slate-100 text-slate-700 text-sm rounded">
                {keyword}
              </span>
            ))}
          </div>
        </div>
      )}

      <!-- Categories -->
      {paperData.categories && paperData.categories.length > 0 && (
        <div>
          <h2 class="text-sm font-semibold text-slate-700 mb-2">Categories</h2>
          <div class="flex flex-wrap gap-2">
            {paperData.categories.map(cat => (
              <span class="px-3 py-1 bg-emerald-50 text-emerald-700 text-sm font-medium rounded">
                {cat}
              </span>
            ))}
          </div>
        </div>
      )}

      <!-- Access Information -->
      {paperData.access && (
        <div class="bg-slate-50 border border-slate-200 rounded-xl p-6">
          <h2 class="text-sm font-semibold text-slate-700 mb-4">Access</h2>
          <div class="space-y-3">
            {/* Access Status */}
            <div class="flex items-center space-x-2">
              <span class="text-sm text-slate-600">Status:</span>
              {paperData.access.status === 'open' && (
                <span class="px-2 py-1 bg-green-100 text-green-800 text-sm font-medium rounded">
                  {t('status.openAccess', locale)}
                </span>
              )}
              {paperData.access.status === 'closed' && (
                <span class="px-2 py-1 bg-red-100 text-red-800 text-sm font-medium rounded">
                  {t('status.closedAccess', locale)}
                </span>
              )}
              {paperData.access.status === 'unknown' && (
                <span class="px-2 py-1 bg-slate-100 text-slate-800 text-sm font-medium rounded">
                  {t('status.unknown', locale)}
                </span>
              )}
            </div>

            {/* License */}
            {paperData.access.licenseUrl && (
              <div>
                <a
                  href={paperData.access.licenseUrl}
                  target="_blank"
                  rel="noreferrer"
                  class="text-emerald-700 hover:text-emerald-800 text-sm font-medium"
                >
                  {t('common.viewLicense', locale)}
                </a>
              </div>
            )}

            {/* Download PDF and Publisher Page */}
            {(paperData.access.localPdfUrl || paperData.access.sourceUrl) && (
              <div class="flex flex-wrap gap-3">
                {paperData.access.localPdfUrl && (
                  <a
                    href={`${basePath}${paperData.access.localPdfUrl}`}
                    target="_blank"
                    rel="noreferrer"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition-colors"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="7 10 12 15 17 10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    {t('common.downloadPdf', locale)}
                  </a>
                )}
                {paperData.access.sourceUrl && (
                  <a
                    href={paperData.access.sourceUrl}
                    target="_blank"
                    rel="noreferrer"
                    class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition-colors"
                  >
                    {t('common.viewPublisherPage', locale)}
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                      <polyline points="15 3 21 3 21 9"></polyline>
                      <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                  </a>
                )}
              </div>
            )}

            {/* ResearchGate */}
            {paperData.access.researchGateUrl && (
              <div>
                <a
                  href={paperData.access.researchGateUrl}
                  target="_blank"
                  rel="noreferrer"
                  class="text-emerald-700 hover:text-emerald-800 text-sm font-medium"
                >
                  {t('common.viewOnResearchGate', locale)}
                </a>
              </div>
            )}
          </div>
        </div>
      )}

      <!-- Back to Library -->
      <div class="pt-6 border-t border-slate-200">
        <a
          href={`${basePath}${locale}/library/`}
          class="text-emerald-700 hover:text-emerald-800 font-medium"
        >
          ‚Üê {t('common.backToLibrary', locale)}
        </a>
      </div>
    </article>
  </main>
</BaseLayout>
